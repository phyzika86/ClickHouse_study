# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ClickHouse —Å Docker Compose

–≠—Ç–æ—Ç —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä ClickHouse –∏ –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∏–º.

## –°–µ—Ä–≤–∏—Å—ã

### 1. –°–µ—Ä–≤–µ—Ä ClickHouse (`clickhouse-server`)

- **–û–±—Ä–∞–∑**: –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π `clickhouse/clickhouse-server:latest`
- **–ü–æ—Ä—Ç—ã**:
  - `8123` - HTTP-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (REST API)
  - `9000` - –ù–∞—Ç–∏–≤–Ω—ã–π TCP-–ø—Ä–æ—Ç–æ–∫–æ–ª
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**:
  - –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `./data` –Ω–∞ —Ö–æ—Å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ `/var/lib/clickhouse`
- **–õ–∏–º–∏—Ç—ã —Ä–µ—Å—É—Ä—Å–æ–≤**:
  - –õ–∏–º–∏—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 262144 (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è —Ä–∞–±–æ—Ç—ã ClickHouse)

### 2. –ö–ª–∏–µ–Ω—Ç ClickHouse (`clickhouse-client`)

- **–û–±—Ä–∞–∑**: –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π `clickhouse/clickhouse-client:latest`
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: –û–∂–∏–¥–∞–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ `clickhouse-server`

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã:
   ```bash
   docker-compose up -d
   ```
   
## –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ python –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ë–î

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ 
   ```bash
   docker-compose exec python-app python /app/demo.py
   ```

2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
   ```bash
   docker-compose exec clickhouse clickhouse-client --user admin --password password123
   docker exec -it clickhouse_db bash
   ```
   - **`clickhouse`** ‚Äî –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ –∏–∑ `docker-compose.yml`.  
   - **`clickhouse-client`** ‚Äî –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ ClickHouse.  
   - **`--user admin --password password123`** ‚Äî —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
   ```bash 
   docker exec -it clickhouse bash
   ```
   - **`clickhouse`** ‚Äî –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–∑ `docker-compose.yml`.

4. –°–∫—Ä–∏–ø—Ç –ø–æ –∑–∞–ª–∏–≤–∫–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ insert_data.txt. –ó–∞–ª–∏–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±—ã–ª–∞ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ —á–µ—Ä–µ–∑
   s3. –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ trips –±–∞–∑—ã default —Å–æ—Å—Ç–∞–≤–∏–ª–æ 1999657

5. –ë—ã–ª–∏ –≤—ã–ø–æ–ª–µ–Ω–Ω—ã –∑–∞–ø—Ä–æ—Å—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ query.txt
    ```sql
    SELECT pickup_date
    FROM trips
    LIMIT 10;
   
    SELECT DISTINCT pickup_date
    FROM trips
    LIMIT 10;
   
    SELECT max(passenger_count)
    FROM trips;
   ```
   
## –ó–∞–≥—Ä—É–∑–∫–∞ –µ—â–µ –æ–¥–Ω–æ–π –ë–î –±–æ–ª—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞

1. –ë—ã–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ë–î https://clickhouse.com/docs/getting-started/example-datasets/noaa

2. –í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∑–∞—è–≤–ª–µ–Ω–æ, —á—Ç–æ –ë–î –Ω–∞ 2.5 –º–ª—Ä–¥ –∑–∞–ø–∏—Å–µ–π, –æ–¥–Ω–∞–∫–æ –ø–æ –∏—Ç–æ–≥—É –≤—ã—è—Å–Ω–∏–ª–æ—Å—å, —á—Ç–æ –∑–∞–ø–∏—Å–µ–π —Ç–∞–º –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 1+ –º–ª—Ä–¥.
   –û—Ç—á–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ —Ñ–∞–π–ª–µ query

3. –í—ã–ø–æ–ª–Ω–∏–ª –∑–∞–ø—Ä–æ—Å—ã:
   ```bash
   SET send_logs_level = 'trace';
   SELECT count() FROM noaa WHERE toYear(date) = 2000;
   ```
   
## –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≥–æ, —á—Ç–æ –±–∞–∑–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ—Ç—Å—è
 ```bash
 curl -X POST "http://localhost:8123/" --user "admin:password123" --data-binary "SELECT 1"
 ```

2. –ë—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Apache JMeter –¥–ª—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
clickhouse-jdbc-0.4.6.jar –ø–æ–º–µ—â–µ–Ω –≤ –ø–∞–ø–∫—É lib –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç—Ä–∏–∏.
–°–æ–∑–¥–∞–Ω Test Plan -> Thread Group -> JDBC Connection Configuration -> JDBC Request

3. –ë—ã–ª –≤—ã–ø–æ–ª–Ω–µ –∑–∞–ø—Ä–æ—Å —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ Thread properies:
# üßµ Thread Properties –≤ JMeter

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –≤ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:

## ‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Ç–æ–∫–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä                      | –û–ø–∏—Å–∞–Ω–∏–µ                                                                 |
|-------------------------------|--------------------------------------------------------------------------|
| **Number of Threads (users)** | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–æ—Ç–æ–∫–æ–≤) –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏. <br> –ü—Ä–∏–º–µ—Ä: `100` = 100 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. |
| **Ramp-Up Period (seconds)**  | –í—Ä–µ–º—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤. <br> üîπ `100` –ø–æ—Ç–æ–∫–æ–≤ —Å Ramp-Up `10` —Å–µ–∫ = 10 –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–µ–∫—É–Ω–¥—É. <br> üîπ `0` = –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤. |
| **Loop Count**                | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π —Å—Ü–µ–Ω–∞—Ä–∏—è –∫–∞–∂–¥—ã–º –ø–æ—Ç–æ–∫–æ–º. <br> üî∏ –ß–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `5`) - –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–ø–æ–ª–Ω–∏—Ç —Ç–µ—Å—Ç 5 —Ä–∞–∑. <br> üî∏ `Forever` - –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ —Ä—É—á–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏. |

```properties
Number of Threads: 100
Ramp-Up Period: 1 (—Å–µ–∫—É–Ω–¥)
Loop Count: 5
```

```sql
SELECT tempMin FROM noaa where tempMin > 0 limit 10000;
```

# –ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
| –ú–µ—Ç—Ä–∏–∫–∞                     | –ó–Ω–∞—á–µ–Ω–∏–µ             | –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è                                                                 |
|-----------------------------|----------------------|-------------------------------------------------------------------------------|
| **Samples**                | 500 –∑–∞–ø—Ä–æ—Å–æ–≤         | –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤                                         |
| **Average**                | 2818 ms (2.8 —Å–µ–∫)    | –í—ã—Å–æ–∫–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: –≤–æ–∑–º–æ–∂–Ω—ã —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏–ª–∏ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –ë–î |
| **Median**                 | 30 ms                | –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑—Ä—ã–≤ –º–µ–∂–¥—É —Å—Ä–µ–¥–Ω–∏–º –∏ –º–µ–¥–∏–∞–Ω–æ–π —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –≤—ã–±—Ä–æ—Å–æ–≤    |
| **90% Line**               | 16950 ms (16.95 —Å–µ–∫) | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Å–æ–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è 90-–≥–æ –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—è                              |
| **Throughput**             | 4295.5 req/sec       | –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)    |
| **Error Rate**             | 0.0%                 | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è                                                  |
| **Min/Max**                | 27.1 ms / 969.8 ms   | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –Ω–µ –æ–±—ä—è—Å–Ω—è–µ—Ç 90-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å ‚Üí –±—ã–ª–∏ –±–æ–ª–µ–µ –¥–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã   |
| **Received/Sent**          | 0.0 / 36624.1 KB     | –ë–æ–ª—å—à–æ–π –æ–±—ä—ë–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö (36.6 –ú–ë)                                   |


# –ö–ª–∞—Å—Ç–µ—Ä –∏–∑ 2 —à–∞—Ä–¥–æ–≤ –≤ –∫–∞–∂–¥–æ–º –ø–æ –¥–≤–µ —Ä–µ–ø–ª–∏–∫–∏
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä
   ```bash
   docker-compose -f docker-compose.cluster.yml up -d
   ```
2. –î–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –∫–æ–Ω–Ω–µ–∫—Ç–∞ –∫ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–∫–∏–Ω—É—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```html
<listen_host>0.0.0.0</listen_host>
<listen_try>1</listen_try>
```

3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –ø–æ –∑–∞–ª–∏–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–ª–∞—Å—Ç–µ—Ä
   ```bash
   docker-compose exec python-app python /app/democluster.py
   ```

4. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø–µ—Ä–µ–ª–∏–≤–∫–∏ –±—ã–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Ä—è–¥ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ query_cluster.
   –ü–µ—Ä–≤–æ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ, —á—Ç–æ –æ–Ω–∏ –≤—ã–ø–æ–ª–Ω–∏–ª–∏—Å—å –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏ –Ω–µ —Ö—É–∂–µ, —á–µ–º –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ–¥–µ. 